name: trivy
on:
  push:
    branches:
    - main
    - staging
  pull_request:
jobs:
  build:
    name: Build
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Run Trivy vulnerability scanner in fs mode
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: fs
        scan-ref: '.'
        output: trivy-results.txt

    - name: Publish Trivy Output to Summary
      run: |
        if [[ -s trivy-results.txt ]]; then
          {
            echo "### Security Output"
            echo "<details><summary>Click to expand</summary>"
            echo ""
            echo '```terraform'
            cat trivy-results.txt
            echo '```'
            echo "</details>"
          } >> $GITHUB_STEP_SUMMARY
        fi

    - name: Parse Trivy results and push to Prometheus
      env:
        REPO_NAME: ${{ github.repository }}
      run: |
        high_count=0
        critical_count=0

        if [[ -f trivy-results.txt ]]; then
          high_count=$(grep -c 'HIGH' trivy-results.txt || echo 0)
          critical_count=$(grep -c 'CRITICAL' trivy-results.txt || echo 0)
        fi

        echo "High vulnerabilities: $high_count"
        echo "Critical vulnerabilities: $critical_count"

        job_name="github_actions_${GITHUB_RUN_ID}"
        repo_name="${REPO_NAME}"

        cat <<EOF | curl --data-binary @- http://143.47.187.120:9091/metrics/job/$job_name
        github_actions_high_vulnerabilities{job="$job_name", repo="$repo_name"} $high_count
        github_actions_critical_vulnerabilities{job="$job_name", repo="$repo_name"} $critical_count
        EOF
